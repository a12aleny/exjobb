<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Datachannel test</title>
	<script src="https://cdn.firebase.com/js/client/2.2.2/firebase.js"></script>
	<script src="webrtc.js"> </script>
	<script src="spelet.js"> </script>
</head>

<script>
	
	var ctx;
    
    var dx = 1;
    var dy = 1;
    var canvasHeight = 100;
    var canvasWidth = 150;
    var x = 50;
    var y = 50;
    var cubeSize = 20;
    var heroID;
    var number;
    var started;
    var iPressed = false;
    var i = 0;
    var theInterval;
    var theArray=[];
    var thePongArray=[];
    var theOutputString="";
    var sendPacket;



    function init() {
        var canvas = document.createElement("canvas");
        ctx = canvas.getContext("2d");
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        document.body.appendChild(canvas);


    }

    function draw() {

    	if (performance.now()-started > 10000 && iPressed == true) {
    		var a = window.document.createElement('a');
    		for (var z = 1; z < i; z++) {
    			theArray[z] = thePongArray[z] - theArray[z];
    		};
    		for (var j = 1; j < theArray.length; j++) {
    			theOutputString += theArray[j].toString() + "\n";
    		};
		    a.href = window.URL.createObjectURL(new Blob([theOutputString], {
		        type: 'text/csv'
		    }));
		    a.download = 'statistic-webrtc-' + number + '.csv';
		    document.body.appendChild(a);
		    a.click();
		    document.body.removeChild(a);
		    clearInterval(theInterval);
    	};

        /*ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        ctx.beginPath();
        ctx.fillStyle = "#0000ff";
        ctx.rect(x, y, cubeSize, cubeSize);
        ctx.closePath();
        ctx.fill();*/

        if (x < 0 || x + cubeSize > canvasWidth) dx = -dx;
        if (y < 0 || y + cubeSize > canvasHeight) dy = -dy;
        x += dx;
        y += dy;

		
       i++;
        //Update my plyers position on the server

        sendPacket = JSON.stringify({
    		            "id": id,
    		            "x": x,
    		            "y": y,
    		            "t": i
    		        });
        for (var j = 0; j < connectedPeers.length; j++) {
    		connectedPeers[j].send(sendPacket);
    	};
       
        theArray[i] = performance.now();
         

    }


     function doABarrelRoll(){
    	iPressed = true;
    	number = prompt("Antal peers?");
    	for (var k = 0; k < connectedPeers.length; k++) {
    		connectedPeers[k].send(JSON.stringify({"msg": "start"}));
    	};
    	started = performance.now();
    	theInterval = setInterval(draw, 1000 / 30);
    	
    }
    function openNew(){
    	window.open("file:///E:/Dropbox/Exjobb/exjobb/p2p/index.html", "_blank", "width=160, height=160");
    }
</script>
<body onload="init();">
<button onclick="doABarrelRoll();">Go</button>
<button onclick="openNew();">+1</button>

</body>
</html>